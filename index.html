<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAMPLY Mitra - Dashboard Toko</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Chart.js for Graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F1F5F9; }
        .sidebar-active { background-color: #1e293b; border-left: 4px solid #22c55e; }
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .status-badge-siap { background-color: #e0f2fe; color: #0284c7; } 
        .status-badge-sewa { background-color: #dcfce7; color: #166534; } 
        .status-badge-selesai { background-color: #f1f5f9; color: #475569; } 
        .status-badge-telat { background-color: #fee2e2; color: #991b1b; } 
        .status-badge-hangus { background-color: #1e293b; color: #f8fafc; } 
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- MOCK DATA ---
        const INITIAL_PROFILE = {
            name: "Mount Trekker Bali",
            owner: "Bli Komang",
            phone: "081999888777",
            address: "Jl. A. Yani No. 88, Singaraja",
            mapsUrl: "https://goo.gl/maps/abc",
            hours: "09:00 - 21:00",
            isOpen: true
        };

        const INITIAL_INVENTORY = [
            { id: 201, name: "Tenda Consina (Kap 2)", category: "Tenda", price: 35000, stock: 8, totalStock: 10, status: "Ready" },
            { id: 202, name: "Sleeping Bag Polar", category: "Tidur", price: 15000, stock: 20, totalStock: 25, status: "Ready" },
            { id: 203, name: "Sepatu Trekking (Size 42)", category: "Aksesoris", price: 40000, stock: 1, totalStock: 3, status: "Ready" },
            { id: 204, name: "Kompor Portable (Rusak)", category: "Masak", price: 20000, stock: 0, totalStock: 2, status: "Maintenance" },
            { id: 205, name: "Carrier Eiger 60L", category: "Tas", price: 45000, stock: 5, totalStock: 5, status: "Ready" }
        ];

        const INITIAL_CUSTOMERS = [
            { id: 1, name: "Melia Putri", phone: "08123456789", totalSewa: 5, lateCount: 0, isBlacklist: false },
            { id: 2, name: "Agus Setiawan", phone: "08123456000", totalSewa: 2, lateCount: 1, isBlacklist: false },
            { id: 3, name: "Budi Santoso", phone: "081999000111", totalSewa: 1, lateCount: 1, isBlacklist: true }
        ];

        const INITIAL_ORDERS = [
            { id: 'MTB-9932', customer: "Melia Putri", phone: "08123456789", items: [{name: "Carrier Eiger", qty: 1, price: 45000}], pickupDate: '2023-11-01T09:00:00', dueDate: '2023-11-02T22:00:00', status: 'Selesai', paymentStatus: 'Lunas', paymentMethod: 'QRIS', fine: 0, damageCost: 0, totalPrice: 45000, paidAmount: 45000, timestamp: '2023-10-31 14:00' },
            { id: 'MTB-1001', customer: "Agus Setiawan", phone: "08123456000", items: [{name: "Tenda Consina", qty: 1, price: 35000}], pickupDate: '2025-12-27T10:00:00', dueDate: '2025-12-28T22:00:00', status: 'Siap Diambil', paymentStatus: 'DP 50%', paymentMethod: 'Transfer VA', fine: 0, damageCost: 0, totalPrice: 35000, paidAmount: 17500, timestamp: '2025-12-26 08:30' },
            { id: 'MTB-1002', customer: "Siti Aminah", phone: "08123456111", items: [{name: "Sleeping Bag", qty: 2, price: 15000}], pickupDate: '2025-12-26T11:00:00', dueDate: '2025-12-27T22:00:00', status: 'Sedang Disewa', paymentStatus: 'Lunas', paymentMethod: 'QRIS', fine: 0, damageCost: 0, totalPrice: 30000, paidAmount: 30000, timestamp: '2025-12-26 11:00' },
            { id: 'MTB-1005', customer: "Doni Tata", phone: "081222333444", items: [{name: "Matras", qty: 2, price: 5000}], pickupDate: '2023-12-20T08:00:00', dueDate: '2023-12-21T22:00:00', status: 'Hangus', paymentStatus: 'DP 50%', paymentMethod: 'Transfer VA', fine: 0, damageCost: 0, totalPrice: 10000, paidAmount: 5000, timestamp: '2023-12-19 20:00' }
        ];

        const INITIAL_REVIEWS = [
            { id: 1, user: "Melia Putri", rating: 5, text: "Barang bagus, bersih!", reply: "" },
            { id: 2, user: "Budi Santoso", rating: 2, text: "Tenda agak bau.", reply: "", isHidden: false }
        ];

        // --- UTILS ---
        const formatRupiah = (num) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(num);
        const formatDateIndo = (dateStr) => {
            if(!dateStr) return "-";
            const date = new Date(dateStr);
            return date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        };

        // --- COMPONENTS ---

        const LoginScreen = ({ onLogin }) => {
            const [username, setUsername] = useState("");
            const [password, setPassword] = useState("");
            const [error, setError] = useState("");

            const handleLogin = (e) => {
                e.preventDefault();
                if(username === "mitra" && password === "admin123") onLogin();
                else setError("Username: mitra | Pass: admin123");
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-800">
                    <div className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm">
                        <div className="text-center mb-6">
                            <h1 className="text-2xl font-bold text-slate-800">CAMPLY <span className="text-green-600">MITRA</span></h1>
                            <p className="text-slate-500 text-sm">Login Pemilik Toko</p>
                        </div>
                        <form onSubmit={handleLogin} className="space-y-4">
                            <input type="text" value={username} onChange={e=>setUsername(e.target.value)} className="w-full border p-2 rounded" placeholder="Username" />
                            <input type="password" value={password} onChange={e=>setPassword(e.target.value)} className="w-full border p-2 rounded" placeholder="Password" />
                            {error && <p className="text-red-500 text-xs text-center">{error}</p>}
                            <button className="w-full bg-slate-900 text-white py-2 rounded hover:bg-slate-800 font-bold">Masuk</button>
                        </form>
                    </div>
                </div>
            );
        };

        const Dashboard = ({ onLogout }) => {
            const [activeTab, setActiveTab] = useState("dashboard");
            const [inventory, setInventory] = useState(INITIAL_INVENTORY);
            const [orders, setOrders] = useState(INITIAL_ORDERS);
            const [customers, setCustomers] = useState(INITIAL_CUSTOMERS);
            const [reviews, setReviews] = useState(INITIAL_REVIEWS);
            const [profile, setProfile] = useState(INITIAL_PROFILE);

            // --- LOGIC FUNCTIONS ---
            
            const calculateFine = (order) => {
                const today = new Date(); 
                const dueDate = new Date(order.dueDate);
                if (today > dueDate) {
                    const diffTime = Math.abs(today - dueDate);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                    const currentHour = today.getHours();
                    let finePercentage = 0.5; let statusText = "Telat Ringan (< 12:00)";
                    if (currentHour >= 12) { finePercentage = 1.0; statusText = "Telat Berat (> 12:00)"; }
                    const fineAmount = order.totalPrice * finePercentage * diffDays;
                    return { amount: fineAmount, status: statusText, daysLate: diffDays };
                }
                return { amount: 0, status: "Tepat Waktu", daysLate: 0 };
            };

            // --- SUB-VIEWS ---

            const DashboardView = () => {
                useEffect(() => {
                    const ctx = document.getElementById('trendChart');
                    if(ctx) {
                        const existingChart = Chart.getChart(ctx);
                        if (existingChart) existingChart.destroy();

                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: ['Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab', 'Min'],
                                datasets: [{ label: 'Transaksi', data: [12, 19, 3, 5, 2, 3, 10], borderColor: '#22c55e', tension: 0.1 }]
                            },
                            options: { responsive: true, maintainAspectRatio: false }
                        });
                    }
                }, []);

                const returningToday = orders.filter(o => o.status === 'Sedang Disewa' && new Date(o.dueDate).getDate() === new Date().getDate());
                const lowStock = inventory.filter(i => i.stock < 2);

                return (
                    <div className="fade-in space-y-6">
                        <h2 className="text-2xl font-bold text-slate-800">Dashboard</h2>
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div className="bg-white p-4 rounded-xl shadow-sm border-l-4 border-l-green-500">
                                <p className="text-xs text-slate-500 uppercase">Pendapatan Hari Ini</p>
                                <h3 className="text-xl font-bold text-slate-800">{formatRupiah(500000)}</h3>
                            </div>
                            <div className="bg-white p-4 rounded-xl shadow-sm border-l-4 border-l-blue-500">
                                <p className="text-xs text-slate-500 uppercase">Unit Keluar</p>
                                <h3 className="text-xl font-bold text-slate-800">{orders.filter(o=>o.status==='Sedang Disewa').length} Unit</h3>
                            </div>
                            <div className="bg-white p-4 rounded-xl shadow-sm border-l-4 border-l-yellow-500">
                                <p className="text-xs text-slate-500 uppercase">Siap Diambil</p>
                                <h3 className="text-xl font-bold text-slate-800">{orders.filter(o=>o.status==='Siap Diambil').length} Pesanan</h3>
                            </div>
                            <div className="bg-white p-4 rounded-xl shadow-sm border-l-4 border-l-purple-500">
                                <p className="text-xs text-slate-500 uppercase">Total Member</p>
                                <h3 className="text-xl font-bold text-slate-800">{customers.length} Orang</h3>
                            </div>
                        </div>
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div className="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm border">
                                <h4 className="font-bold mb-4">Tren Transaksi Mingguan</h4>
                                <div className="h-64"><canvas id="trendChart"></canvas></div>
                            </div>
                            <div className="space-y-4">
                                <div className="bg-white p-4 rounded-xl shadow-sm border">
                                    <h4 className="font-bold mb-3 flex items-center gap-2"><i className="fas fa-undo text-blue-500"></i> Jadwal Kembali Hari Ini</h4>
                                    {returningToday.length === 0 ? <p className="text-sm text-slate-400">Tidak ada jadwal.</p> : (
                                        <ul className="space-y-2">{returningToday.map(o => (<li key={o.id} className="text-sm border-b pb-2"><div className="font-bold text-slate-800">{o.customer}</div><div className="flex justify-between text-xs text-slate-500"><span>{o.id}</span><span className="text-red-500 font-bold">Max 22:00</span></div></li>))}</ul>
                                    )}
                                </div>
                                <div className="bg-red-50 p-4 rounded-xl border border-red-100">
                                    <h4 className="font-bold text-red-800 mb-2"><i className="fas fa-exclamation-triangle"></i> Stok Menipis</h4>
                                    <ul className="space-y-1">{lowStock.map(i => <li key={i.id} className="text-xs text-red-700">â€¢ {i.name} (Sisa {i.stock})</li>)}</ul>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const POSView = () => {
                const [tab, setTab] = useState('pickup');
                const [scanVal, setScanVal] = useState("");
                const [pickupData, setPickupData] = useState(null);
                
                const [cart, setCart] = useState([]);
                const [walkinCategory, setWalkinCategory] = useState("Semua");
                const [walkinSearch, setWalkinSearch] = useState("");
                const [walkinCustomerPhone, setWalkinCustomerPhone] = useState("");
                const [walkinCustomerName, setWalkinCustomerName] = useState("");
                const [isNewCustomer, setIsNewCustomer] = useState(true);
                const [walkinPayMethod, setWalkinPayMethod] = useState("Cash");
                const [rentalDuration, setRentalDuration] = useState(1);

                // PICKUP
                const checkPickup = (e) => {
                    e.preventDefault();
                    const order = orders.find(o => o.id === scanVal);
                    if (!order) return alert("ID Pesanan Tidak Ditemukan!");
                    setPickupData(order);
                };

                const processPickup = (payOff) => {
                    const updated = orders.map(o => o.id === pickupData.id ? { ...o, status: 'Sedang Disewa', paymentStatus: 'Lunas', paidAmount: o.totalPrice } : o);
                    setOrders(updated);
                    setPickupData(null);
                    setScanVal("");
                    alert("Barang berhasil diserahkan! Status: Sedang Disewa.");
                };

                // WALKIN LOGIC
                const checkMember = () => {
                    const cust = customers.find(c => c.phone === walkinCustomerPhone);
                    if (cust) {
                        setWalkinCustomerName(cust.name);
                        setIsNewCustomer(false);
                    } else {
                        setWalkinCustomerName("");
                        setIsNewCustomer(true);
                    }
                };

                const addToCart = (item) => {
                    if (item.stock === 0) return alert("Stok Habis!");
                    const exist = cart.find(c => c.id === item.id);
                    if(exist) {
                        if (exist.qty >= item.stock) return alert("Mencapai batas stok!");
                        setCart(cart.map(c => c.id === item.id ? {...c, qty: c.qty+1} : c));
                    } else {
                        setCart([...cart, {...item, qty: 1}]);
                    }
                };

                const changeQty = (id, delta, max) => {
                    setCart(cart.map(item => {
                        if (item.id === id) {
                            const newQty = Math.max(1, Math.min(max, item.qty + delta));
                            return { ...item, qty: newQty };
                        }
                        return item;
                    }));
                };

                const finishWalkin = () => {
                    if(!walkinCustomerPhone || !walkinCustomerName || cart.length === 0) return alert("Lengkapi data!");
                    
                    const itemTotal = cart.reduce((a,b)=>a+(b.price*b.qty),0);
                    const grandTotal = itemTotal * rentalDuration;

                    const newOrder = {
                        id: `POS-${Math.floor(Math.random()*9000)}`,
                        customer: walkinCustomerName,
                        phone: walkinCustomerPhone,
                        items: cart,
                        pickupDate: new Date().toISOString(),
                        dueDate: new Date(Date.now() + (rentalDuration * 86400000)).toISOString(),
                        status: 'Sedang Disewa',
                        paymentStatus: 'Lunas',
                        paymentMethod: walkinPayMethod,
                        totalPrice: grandTotal,
                        paidAmount: grandTotal,
                        fine: 0, damageCost: 0,
                        date: new Date().toISOString().split('T')[0],
                        timestamp: new Date().toLocaleString()
                    };
                    
                    // Add new customer if needed (simplified)
                    if(isNewCustomer) {
                        setCustomers([...customers, {id: Date.now(), name: walkinCustomerName, phone: walkinCustomerPhone, totalSewa: 1, lateCount: 0}]);
                    }

                    setOrders([newOrder, ...orders]);
                    setCart([]);
                    setWalkinCustomerPhone("");
                    setWalkinCustomerName("");
                    setRentalDuration(1);
                    alert("Transaksi Walk-in Berhasil!");
                };

                const categories = ["Semua", ...new Set(inventory.map(i => i.category))];
                const filteredInventory = inventory.filter(i => 
                    i.status === 'Ready' && 
                    (walkinCategory === "Semua" || i.category === walkinCategory) &&
                    i.name.toLowerCase().includes(walkinSearch.toLowerCase())
                );

                return (
                    <div className="fade-in h-full flex flex-col">
                        <div className="flex gap-2 mb-4 border-b pb-2">
                            <button onClick={()=>setTab('pickup')} className={`px-4 py-2 rounded-lg font-bold ${tab==='pickup'?'bg-slate-900 text-white':'text-slate-500'}`}>Ambil Pesanan (Online)</button>
                            <button onClick={()=>setTab('walkin')} className={`px-4 py-2 rounded-lg font-bold ${tab==='walkin'?'bg-slate-900 text-white':'text-slate-500'}`}>Transaksi Baru (Walk-in)</button>
                        </div>

                        {tab === 'pickup' ? (
                            <div className="max-w-2xl">
                                <form onSubmit={checkPickup} className="flex gap-2 mb-6">
                                    <input type="text" value={scanVal} onChange={e=>setScanVal(e.target.value)} className="flex-1 border p-3 rounded font-mono uppercase" placeholder="Scan QR / Input ID Pesanan" autoFocus />
                                    <button className="bg-green-600 text-white px-6 rounded font-bold">Cek</button>
                                </form>
                                {pickupData ? (
                                    <div className="bg-white p-6 rounded-xl shadow border animate-fade-in">
                                        <div className="flex justify-between items-start mb-4 border-b pb-4">
                                            <div>
                                                <h3 className="font-bold text-xl">{pickupData.id}</h3>
                                                <p className="text-slate-500 text-sm">Booking: {pickupData.timestamp}</p>
                                            </div>
                                            <div className="text-right">
                                                <span className={`px-2 py-1 rounded text-xs font-bold ${pickupData.paymentStatus==='Lunas'?'bg-green-100 text-green-700':'bg-yellow-100 text-yellow-700'}`}>{pickupData.paymentStatus}</span>
                                                <p className="text-xs text-slate-500 mt-1">{pickupData.paymentMethod}</p>
                                            </div>
                                        </div>
                                        <div className="mb-4">
                                            <p className="font-bold text-slate-800 mb-2">Rincian Barang:</p>
                                            <ul className="bg-slate-50 p-3 rounded text-sm space-y-1">
                                                {pickupData.items.map((item, i) => (
                                                    <li key={i} className="flex justify-between">
                                                        <span>{item.name}</span>
                                                        <span className="font-bold">x{item.qty}</span>
                                                    </li>
                                                ))}
                                            </ul>
                                        </div>
                                        <div className="flex justify-between font-bold text-lg mb-6">
                                            <span>Total Pesanan</span>
                                            <span>{formatRupiah(pickupData.totalPrice)}</span>
                                        </div>

                                        {pickupData.paymentStatus === 'Lunas' ? (
                                            <div className="text-center">
                                                <div className="bg-green-50 p-3 rounded text-green-800 font-bold mb-4"><i className="fas fa-check-circle"></i> SUDAH LUNAS</div>
                                                <button onClick={()=>processPickup(false)} className="w-full bg-slate-900 text-white py-3 rounded font-bold">Serahkan Barang</button>
                                            </div>
                                        ) : (
                                            <div className="text-center">
                                                <div className="bg-yellow-50 p-3 rounded text-yellow-800 font-bold mb-4">
                                                    Sisa Tagihan: {formatRupiah(pickupData.totalPrice - pickupData.paidAmount)}
                                                </div>
                                                <button onClick={()=>processPickup(true)} className="w-full bg-blue-600 text-white py-3 rounded font-bold">Terima Pelunasan & Serahkan</button>
                                            </div>
                                        )}
                                    </div>
                                ) : (scanVal && <div className="text-center text-red-500 font-bold mt-4">ID Pesanan Tidak Ditemukan!</div>)}
                            </div>
                        ) : (
                            <div className="flex gap-6 h-full">
                                <div className="flex-1 overflow-y-auto pr-2">
                                    <div className="flex gap-2 mb-4 overflow-x-auto pb-2">
                                        {categories.map(c => (
                                            <button key={c} onClick={()=>setWalkinCategory(c)} className={`px-3 py-1 rounded-full text-xs font-bold whitespace-nowrap ${walkinCategory===c?'bg-slate-800 text-white':'bg-white border'}`}>{c}</button>
                                        ))}
                                    </div>
                                    <input type="text" placeholder="Cari alat..." className="w-full p-2 border rounded mb-4 text-sm" value={walkinSearch} onChange={e=>setWalkinSearch(e.target.value)} />
                                    <div className="grid grid-cols-3 gap-3">
                                        {filteredInventory.map(item => (
                                            <div key={item.id} onClick={()=>addToCart(item)} className="bg-white p-3 rounded border cursor-pointer hover:border-green-500">
                                                <p className="font-bold text-sm">{item.name}</p>
                                                <p className="text-xs text-green-600">{formatRupiah(item.price)}</p>
                                                <p className="text-[10px]">Stok: {item.stock}</p>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                <div className="w-80 bg-white border-l p-4 flex flex-col">
                                    <h4 className="font-bold mb-2">Pelanggan</h4>
                                    <div className="flex gap-2 mb-2">
                                        <input 
                                            type="text" 
                                            value={walkinCustomerPhone} 
                                            onChange={e=>setWalkinCustomerPhone(e.target.value)} 
                                            onBlur={checkMember}
                                            className="w-full p-2 border rounded text-sm" 
                                            placeholder="No WA (Otomatis Cek)" 
                                        />
                                    </div>
                                    <input 
                                        type="text" 
                                        value={walkinCustomerName} 
                                        onChange={e=>setWalkinCustomerName(e.target.value)} 
                                        disabled={!isNewCustomer}
                                        className={`w-full p-2 border rounded text-sm mb-4 ${!isNewCustomer ? 'bg-slate-100' : ''}`} 
                                        placeholder="Nama Pelanggan" 
                                    />
                                    
                                    <h4 className="font-bold mb-2">Detail Sewa</h4>
                                    <div className="flex justify-between items-center mb-4">
                                        <span className="text-sm">Durasi (Hari)</span>
                                        <input type="number" min="1" value={rentalDuration} onChange={e=>setRentalDuration(e.target.value)} className="w-16 border p-1 rounded text-center" />
                                    </div>

                                    <h4 className="font-bold mb-2">Keranjang</h4>
                                    <div className="flex-1 overflow-y-auto text-sm space-y-2 mb-4 bg-slate-50 p-2 rounded">
                                        {cart.map((item, idx) => (
                                            <div key={idx} className="flex justify-between items-center border-b pb-1">
                                                <div>
                                                    <span className="font-bold block">{item.name}</span>
                                                    <span className="text-xs">{formatRupiah(item.price)}</span>
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    <button onClick={()=>changeQty(item.id, -1, item.stock)} className="px-2 bg-slate-200 rounded">-</button>
                                                    <span>{item.qty}</span>
                                                    <button onClick={()=>changeQty(item.id, 1, item.stock)} className="px-2 bg-slate-200 rounded">+</button>
                                                </div>
                                            </div>
                                        ))}
                                        {cart.length === 0 && <p className="text-center text-slate-400 text-xs">Belum ada item</p>}
                                    </div>

                                    <div className="mb-4">
                                        <label className="block text-xs font-bold mb-1">Metode Bayar</label>
                                        <select value={walkinPayMethod} onChange={e=>setWalkinPayMethod(e.target.value)} className="w-full p-2 border rounded text-sm">
                                            <option value="Cash">Cash / Tunai</option>
                                            <option value="QRIS">QRIS</option>
                                            <option value="Transfer">Transfer Bank</option>
                                        </select>
                                    </div>

                                    <div className="border-t pt-2">
                                        <div className="flex justify-between text-sm mb-1">
                                            <span>Subtotal Item</span>
                                            <span>{formatRupiah(cart.reduce((a,b)=>a+(b.price*b.qty),0))}</span>
                                        </div>
                                        <div className="flex justify-between font-bold text-lg mb-3">
                                            <span>Total (x{rentalDuration} Hari)</span>
                                            <span>{formatRupiah(cart.reduce((a,b)=>a+(b.price*b.qty),0) * rentalDuration)}</span>
                                        </div>
                                        <button onClick={finishWalkin} className="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700">Proses Sewa</button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            const ReturnView = () => {
                const [scan, setScan] = useState("");
                const [data, setData] = useState(null);
                const [dmg, setDmg] = useState(0);

                const checkReturn = (e) => {
                    e.preventDefault();
                    const order = orders.find(o => o.id === scan);
                    if (!order) return alert("ID Pesanan Tidak Ditemukan!");
                    if(order.status !== 'Sedang Disewa' && order.status !== 'Terlambat') return alert("Status pesanan tidak valid untuk dikembalikan.");
                    
                    const fine = calculateFine(order);
                    setData({...order, fineCalc: fine});
                };

                const finishReturn = () => {
                    const totalPay = data.fineCalc.amount + parseInt(dmg);
                    const updated = orders.map(o => o.id === data.id ? {
                        ...o, status: 'Selesai', fine: totalPay, damageCost: parseInt(dmg), paymentStatus: totalPay > 0 ? 'Lunas + Denda' : 'Lunas'
                    } : o);
                    setOrders(updated);
                    alert("Pengembalian Selesai!");
                    setData(null); setScan(""); setDmg(0);
                };

                return (
                    <div className="fade-in max-w-xl mx-auto">
                        <h2 className="text-2xl font-bold mb-6">Pengembalian Barang</h2>
                        {!data ? (
                            <form onSubmit={checkReturn} className="flex gap-2">
                                <input type="text" value={scan} onChange={e=>setScan(e.target.value)} className="flex-1 border p-3 rounded font-mono uppercase" placeholder="Scan QR Pesanan" autoFocus />
                                <button className="bg-slate-900 text-white px-6 rounded font-bold">Cek</button>
                            </form>
                        ) : (
                            <div className="bg-white p-6 rounded-xl border shadow-lg space-y-4 animate-fade-in">
                                <div className="border-b pb-4">
                                    <h3 className="text-xl font-bold">{data.id}</h3>
                                    <p className="text-slate-500">{data.customer}</p>
                                    <div className="flex justify-between text-sm mt-2">
                                        <span>Ambil: <b>{formatDateIndo(data.pickupDate)}</b></span>
                                        <span>Jadwal: <b>{formatDateIndo(data.dueDate)}</b></span>
                                    </div>
                                </div>

                                <div className="bg-slate-50 p-3 rounded">
                                    <p className="font-bold text-sm mb-2">Item Disewa:</p>
                                    <ul className="text-sm space-y-1">
                                        {data.items.map((i,x) => <li key={x} className="flex justify-between"><span>{i.name}</span><span>x{i.qty}</span></li>)}
                                    </ul>
                                </div>
                                
                                {data.fineCalc.amount > 0 ? (
                                    <div className="bg-red-50 p-4 rounded text-red-800">
                                        <h4 className="font-bold flex items-center gap-2"><i className="fas fa-clock"></i> TERLAMBAT</h4>
                                        <p className="text-sm">{data.fineCalc.status} - Denda: {formatRupiah(data.fineCalc.amount)}</p>
                                    </div>
                                ) : <div className="bg-green-50 p-3 rounded text-green-700 font-bold text-sm">Tepat Waktu. Tidak ada denda.</div>}

                                <div>
                                    <label className="block text-sm font-bold mb-1">Biaya Kerusakan (Opsional)</label>
                                    <input type="number" value={dmg} onChange={e=>setDmg(e.target.value)} className="w-full border p-2 rounded" placeholder="0" />
                                </div>

                                <div className="border-t pt-4 flex justify-between items-center">
                                    <div><p className="text-xs text-slate-500">Total Bayar (Denda+Kerusakan)</p><p className="text-2xl font-bold text-slate-800">{formatRupiah(data.fineCalc.amount + parseInt(dmg))}</p></div>
                                    <button onClick={finishReturn} className="bg-green-600 text-white px-6 py-3 rounded font-bold">Selesai & Restock</button>
                                </div>
                                <button onClick={()=>setData(null)} className="w-full text-slate-400 text-sm mt-2">Batal</button>
                            </div>
                        )}
                    </div>
                );
            };

            const OrdersView = () => {
                const [filterTime, setFilterTime] = useState('all'); 
                const [filterStatus, setFilterStatus] = useState('all');
                const [startDate, setStartDate] = useState("");
                const [endDate, setEndDate] = useState("");

                const filteredOrders = orders.filter(o => {
                    const d = new Date(o.pickupDate);
                    const now = new Date();
                    let timeMatch = true;
                    if (filterTime === 'today') timeMatch = d.toDateString() === now.toDateString();
                    if (filterTime === 'week') { const weekAgo = new Date(); weekAgo.setDate(now.getDate()-7); timeMatch = d >= weekAgo; }
                    if (filterTime === 'month') timeMatch = d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                    
                    if (startDate && endDate) {
                        const start = new Date(startDate); const end = new Date(endDate);
                        timeMatch = d >= start && d <= end;
                    }

                    const statusMatch = filterStatus === 'all' || o.status === filterStatus;
                    return timeMatch && statusMatch;
                });

                return (
                    <div className="fade-in">
                        <div className="flex flex-wrap gap-4 mb-6 items-end">
                            <div><label className="text-xs block mb-1 font-bold">Periode</label><select value={filterTime} onChange={e=>setFilterTime(e.target.value)} className="border p-2 rounded text-sm"><option value="all">Semua</option><option value="today">Hari Ini</option><option value="week">Minggu Ini</option><option value="month">Bulan Ini</option></select></div>
                            <div><label className="text-xs block mb-1 font-bold">Status</label><select value={filterStatus} onChange={e=>setFilterStatus(e.target.value)} className="border p-2 rounded text-sm"><option value="all">Semua Status</option><option value="Siap Diambil">Siap Diambil</option><option value="Sedang Disewa">Sedang Disewa</option><option value="Selesai">Selesai</option><option value="Hangus">Hangus</option></select></div>
                            <div><label className="text-xs block mb-1 font-bold">Dari</label><input type="date" value={startDate} onChange={e=>setStartDate(e.target.value)} className="border p-2 rounded text-sm" /></div>
                            <div><label className="text-xs block mb-1 font-bold">Sampai</label><input type="date" value={endDate} onChange={e=>setEndDate(e.target.value)} className="border p-2 rounded text-sm" /></div>
                        </div>
                        <div className="bg-white rounded-xl border overflow-hidden">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-slate-50 border-b"><tr><th className="p-3">ID</th><th className="p-3">Pelanggan</th><th className="p-3">Status</th><th className="p-3">Total</th><th className="p-3">Tanggal</th></tr></thead>
                                <tbody>
                                    {filteredOrders.map(o => (
                                        <tr key={o.id} className="border-b hover:bg-slate-50">
                                            <td className="p-3 font-mono font-bold">{o.id}</td>
                                            <td className="p-3">{o.customer}<br/><span className="text-xs text-slate-500">{o.phone}</span></td>
                                            <td className="p-3"><span className={`px-2 py-1 rounded text-xs font-bold ${o.status==='Siap Diambil'?'status-badge-siap':o.status==='Sedang Disewa'?'status-badge-sewa':o.status==='Selesai'?'status-badge-selesai':o.status==='Hangus'?'status-badge-hangus':'status-badge-telat'}`}>{o.status}</span></td>
                                            <td className="p-3 font-bold">{formatRupiah(o.totalPrice)}</td>
                                            <td className="p-3 text-slate-500">{formatDateIndo(o.pickupDate)}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                );
            };

            const InventoryView = () => {
                const [search, setSearch] = useState("");
                const [catFilter, setCatFilter] = useState("Semua");
                const [showModal, setShowModal] = useState(false);
                const [editItem, setEditItem] = useState(null);
                const [formData, setFormData] = useState({ name: "", category: "Tenda", price: 0, stock: 0, totalStock: 0, status: "Ready" });

                const categories = ["Semua", ...new Set(inventory.map(i=>i.category))];
                const filtered = inventory.filter(i => (catFilter==="Semua" || i.category===catFilter) && i.name.toLowerCase().includes(search.toLowerCase()));

                const handleAdd = () => {
                    setEditItem(null);
                    setFormData({ name: "", category: "Tenda", price: 0, stock: 0, totalStock: 0, status: "Ready" });
                    setShowModal(true);
                };

                const handleEdit = (item) => {
                    setEditItem(item);
                    setFormData({ ...item });
                    setShowModal(true);
                };

                const handleDelete = (id) => {
                    if(confirm("Hapus barang ini?")) setInventory(inventory.filter(i => i.id !== id));
                };

                const handleSave = () => {
                    if(editItem) {
                        setInventory(inventory.map(i => i.id === editItem.id ? { ...formData, id: editItem.id } : i));
                    } else {
                        setInventory([...inventory, { ...formData, id: Date.now() }]);
                    }
                    setShowModal(false);
                };

                return (
                    <div className="fade-in">
                        <div className="flex justify-between mb-4">
                            <h2 className="text-2xl font-bold">Inventaris</h2>
                            <button onClick={handleAdd} className="bg-slate-900 text-white px-4 py-2 rounded text-sm font-bold">Tambah Barang</button>
                        </div>
                        <div className="flex gap-4 mb-4">
                            <input type="text" placeholder="Cari barang..." className="border p-2 rounded flex-1" value={search} onChange={e=>setSearch(e.target.value)} />
                            <select value={catFilter} onChange={e=>setCatFilter(e.target.value)} className="border p-2 rounded"><option value="Semua">Semua Kategori</option>{categories.filter(c=>c!=="Semua").map(c=><option key={c} value={c}>{c}</option>)}</select>
                        </div>
                        <div className="bg-white rounded-xl border overflow-hidden">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-slate-50 border-b"><tr><th className="p-3">Nama</th><th className="p-3">Kategori</th><th className="p-3">Stok</th><th className="p-3">Status</th><th className="p-3">Aksi</th></tr></thead>
                                <tbody>
                                    {filtered.map(i => (
                                        <tr key={i.id} className="border-b">
                                            <td className="p-3 font-medium">{i.name}</td>
                                            <td className="p-3 text-slate-500">{i.category}</td>
                                            <td className="p-3">{i.stock} / {i.totalStock}</td>
                                            <td className="p-3"><span className={`px-2 py-1 rounded text-xs font-bold ${i.status==='Ready'?'bg-green-100 text-green-700':'bg-red-100 text-red-700'}`}>{i.status}</span></td>
                                            <td className="p-3 flex gap-2">
                                                <button onClick={()=>handleEdit(i)} className="text-blue-600 hover:underline">Edit</button>
                                                <button onClick={()=>handleDelete(i.id)} className="text-red-600 hover:underline">Hapus</button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>

                        {/* Modal */}
                        {showModal && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                                <div className="bg-white p-6 rounded-xl w-full max-w-md">
                                    <h3 className="text-lg font-bold mb-4">{editItem ? "Edit Barang" : "Tambah Barang Baru"}</h3>
                                    <div className="space-y-3">
                                        <input type="text" placeholder="Nama Barang" className="w-full border p-2 rounded" value={formData.name} onChange={e=>setFormData({...formData, name:e.target.value})} />
                                        <input type="text" placeholder="Kategori" className="w-full border p-2 rounded" value={formData.category} onChange={e=>setFormData({...formData, category:e.target.value})} />
                                        <input type="number" placeholder="Harga Sewa" className="w-full border p-2 rounded" value={formData.price} onChange={e=>setFormData({...formData, price:parseInt(e.target.value)})} />
                                        <div className="flex gap-2">
                                            <input type="number" placeholder="Stok Ready" className="w-full border p-2 rounded" value={formData.stock} onChange={e=>setFormData({...formData, stock:parseInt(e.target.value)})} />
                                            <input type="number" placeholder="Total Aset" className="w-full border p-2 rounded" value={formData.totalStock} onChange={e=>setFormData({...formData, totalStock:parseInt(e.target.value)})} />
                                        </div>
                                        <select className="w-full border p-2 rounded" value={formData.status} onChange={e=>setFormData({...formData, status:e.target.value})}>
                                            <option value="Ready">Ready</option>
                                            <option value="Maintenance">Maintenance</option>
                                        </select>
                                    </div>
                                    <div className="flex justify-end gap-2 mt-6">
                                        <button onClick={()=>setShowModal(false)} className="px-4 py-2 text-slate-500 font-bold">Batal</button>
                                        <button onClick={handleSave} className="px-4 py-2 bg-slate-900 text-white rounded font-bold">Simpan</button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            const FinanceView = () => {
                const [timeFilter, setTimeFilter] = useState('all');
                const [typeFilter, setTypeFilter] = useState('all');

                const filteredData = orders.filter(o => {
                    const d = new Date(o.pickupDate);
                    const now = new Date();
                    let timeMatch = true;
                    if(timeFilter === 'today') timeMatch = d.toDateString() === now.toDateString();
                    if(timeFilter === 'week') { const weekAgo = new Date(); weekAgo.setDate(now.getDate()-7); timeMatch = d >= weekAgo; }
                    if(timeFilter === 'month') timeMatch = d.getMonth() === now.getMonth();

                    const type = o.fine > 0 ? 'Denda' : (o.status === 'Hangus' ? 'Hangus' : 'Sewa');
                    const typeMatch = typeFilter === 'all' || type === typeFilter;
                    return timeMatch && typeMatch;
                });

                const totalRev = filteredData.reduce((a,b) => b.status === 'Selesai' ? a + b.totalPrice + b.fine + (b.damageCost||0) : a + (b.paidAmount||0), 0);

                useEffect(() => {
                    const ctx = document.getElementById('financeChart');
                    if(ctx) {
                        const existingChart = Chart.getChart(ctx);
                        if (existingChart) existingChart.destroy();
                        new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: ['Sewa', 'Denda', 'Hangus'],
                                datasets: [{ label: 'Pendapatan', data: [
                                    filteredData.filter(o=>o.fine===0 && o.status!=='Hangus').reduce((a,b)=>a+(b.totalPrice||b.paidAmount),0),
                                    filteredData.reduce((a,b)=>a+b.fine+(b.damageCost||0),0),
                                    filteredData.filter(o=>o.status==='Hangus').reduce((a,b)=>a+b.paidAmount,0)
                                ], backgroundColor: ['#22c55e', '#ef4444', '#1e293b'] }]
                            }
                        });
                    }
                }, [filteredData]);

                const exportExcel = () => {
                    alert("Simulasi: File Excel 'Laporan_Keuangan.xlsx' berhasil diunduh!");
                }

                return (
                    <div className="fade-in">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold">Laporan Keuangan</h2>
                            <div className="flex gap-2">
                                <select value={timeFilter} onChange={e=>setTimeFilter(e.target.value)} className="border p-2 rounded text-sm"><option value="all">Semua Waktu</option><option value="today">Hari Ini</option><option value="week">Minggu Ini</option><option value="month">Bulan Ini</option></select>
                                <select value={typeFilter} onChange={e=>setTypeFilter(e.target.value)} className="border p-2 rounded text-sm"><option value="all">Semua Tipe</option><option value="Sewa">Sewa Murni</option><option value="Denda">Denda/Kerusakan</option><option value="Hangus">Hangus (No Show)</option></select>
                                <button onClick={exportExcel} className="bg-green-600 text-white px-4 py-2 rounded text-sm font-bold"><i className="fas fa-file-excel mr-2"></i> Export Excel</button>
                            </div>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div className="bg-white p-6 rounded-xl border text-center flex flex-col justify-center">
                                <p className="text-slate-500 uppercase text-xs font-bold">Total Pendapatan</p>
                                <h1 className="text-4xl font-bold text-slate-800 mt-2">{formatRupiah(totalRev)}</h1>
                            </div>
                            <div className="bg-white p-4 rounded-xl border h-64">
                                <canvas id="financeChart"></canvas>
                            </div>
                        </div>
                        <div className="bg-white rounded-xl border overflow-hidden">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-slate-50 border-b"><tr><th className="p-3">Tanggal</th><th className="p-3">ID</th><th className="p-3">Tipe</th><th className="p-3">Nominal</th></tr></thead>
                                <tbody>
                                    {filteredData.map(o => (
                                        <tr key={o.id} className="border-b">
                                            <td className="p-3">{formatDateIndo(o.pickupDate)}</td>
                                            <td className="p-3 font-mono">{o.id}</td>
                                            <td className="p-3">{o.fine > 0 ? 'Sewa + Denda' : (o.status === 'Hangus' ? 'Hangus (DP)' : 'Sewa')}</td>
                                            <td className="p-3 font-bold text-green-600">{formatRupiah(o.fine > 0 ? o.totalPrice + o.fine : (o.status === 'Hangus' ? o.paidAmount : o.totalPrice))}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                );
            };

            const CustomerView = () => (
                <div className="fade-in">
                    <h2 className="text-2xl font-bold mb-6">CRM Pelanggan</h2>
                    <div className="grid grid-cols-2 gap-4">
                        {customers.map(c => (
                            <div key={c.id} className="bg-white p-4 rounded border flex justify-between">
                                <div><h4 className="font-bold">{c.name}</h4><p className="text-xs text-slate-500">{c.phone}</p><p className="text-xs mt-1">Sewa: {c.totalSewa}x | Telat: {c.lateCount}x</p></div>
                                <button className={`text-xs px-3 py-1 rounded font-bold h-fit ${c.isBlacklist?'bg-red-600 text-white':'bg-slate-100 text-slate-600'}`}>{c.isBlacklist?'Blacklisted':'Normal'}</button>
                            </div>
                        ))}
                    </div>
                </div>
            );

            const ReviewsView = () => (
                <div className="fade-in">
                    <h2 className="text-2xl font-bold mb-6">Ulasan Pelanggan</h2>
                    <div className="space-y-4">
                        {reviews.map(r => (
                            <div key={r.id} className="bg-white p-4 rounded-xl border">
                                <div className="flex justify-between mb-2">
                                    <span className="font-bold">{r.user}</span>
                                    <div className="flex text-yellow-400 text-xs">{[...Array(r.rating)].map((_,i)=><i key={i} className="fas fa-star"></i>)}</div>
                                </div>
                                <p className="text-sm text-slate-600 mb-3">"{r.text}"</p>
                                <div className="flex gap-2">
                                    <button className="text-xs bg-slate-100 px-3 py-1 rounded">Balas</button>
                                    <button className="text-xs bg-red-50 text-red-500 px-3 py-1 rounded">Sembunyikan</button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );

            // --- MAIN RENDERER ---
            const renderContent = () => {
                switch(activeTab) {
                    case 'dashboard': return <DashboardView />;
                    case 'pos': return <POSView />;
                    case 'return': return <ReturnView />;
                    case 'orders': return <OrdersView />;
                    case 'inventory': return <InventoryView />;
                    case 'customers': return <CustomerView />;
                    case 'finance': return <FinanceView />;
                    case 'reviews': return <ReviewsView />;
                    default: return <DashboardView />;
                }
            };

            return (
                <div className="flex h-screen overflow-hidden">
                    <div className="w-64 bg-slate-900 text-white hidden md:flex flex-col">
                        <div className="p-6 border-b border-slate-800"><h1 className="text-2xl font-bold">CAMPLY <span className="text-green-500">MITRA</span></h1></div>
                        <nav className="flex-1 p-4 space-y-1 overflow-y-auto text-sm font-medium">
                            {['dashboard', 'pos', 'return', 'orders', 'inventory', 'finance', 'customers', 'reviews'].map(tab => (
                                <button key={tab} onClick={()=>setActiveTab(tab)} className={`w-full text-left px-4 py-3 rounded capitalize ${activeTab===tab?'sidebar-active text-white':'text-slate-400 hover:text-white'}`}>{tab}</button>
                            ))}
                        </nav>
                        <div className="p-4 border-t border-slate-800"><button onClick={onLogout} className="w-full bg-red-900/30 text-red-400 py-2 rounded text-xs font-bold">Keluar</button></div>
                    </div>
                    <div className="flex-1 flex flex-col overflow-hidden bg-slate-50">
                        <div className="flex-1 overflow-y-auto p-4 md:p-8">
                            {renderContent()}
                        </div>
                    </div>
                </div>
            );
        };

        const Root = () => {
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            return isLoggedIn ? <Dashboard onLogout={() => setIsLoggedIn(false)} /> : <LoginScreen onLogin={() => setIsLoggedIn(true)} />;
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<Root />);
    </script>
</body>
</html>
